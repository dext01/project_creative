import json
from typing import Dict

"""
main.py ‚Äî –º–æ–¥—É–ª—å –æ—Ü–µ–Ω–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º—ã.

–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
    evaluate_ad(ad_text: str, target_audience: str) -> Dict[str, float]

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
{
    "click_probability": 0.x,
    "purchase_probability": 0.y
}
"""


# –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è).
# –î–ª—è —Ä–∞–±–æ—Ç—ã —Ç–µ–∫—É—â–µ–π –∑–∞–≥–ª—É—à–∫–∏ —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø—É—Å—Ç—å –±—É–¥–µ—Ç.
try:
    with open("category.json", "r", encoding="utf-8") as f:
        AUDIENCE_PROFILES = json.load(f)
except FileNotFoundError:
    AUDIENCE_PROFILES = {}


def evaluate_ad(ad_text: str, target_audience: str) -> Dict[str, float]:
    """
    –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–∫–ª–∞–º—ã.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        ad_text        ‚Äî —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è (headline + text + CTA)
        target_audience ‚Äî —Å—Ç—Ä–æ–∫–æ–≤—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ–≥–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Low_income_pragmatic_youth")

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        {
            "click_probability": float –æ—Ç 0 –¥–æ 1,
            "purchase_probability": float –æ—Ç 0 –¥–æ 1
        }

    –õ–æ–≥–∏–∫–∞:
    - –ë–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä = 0.5
    - –ó–∞ "—Å–∫–∏–¥–∫—É", "–Ω–æ–≤–∏–Ω–∫—É", "–±–µ—Å–ø–ª–∞—Ç–Ω–æ" –∏ —Ç.–ø. –¥–æ–±–∞–≤–ª—è–µ–º –æ—á–∫–∏
    - –ó–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî —à—Ç—Ä–∞—Ñ
    - –î–ª—è –º–∞–ª–æ–æ–±–µ—Å–ø–µ—á—ë–Ω–Ω–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Å–∫–∏–¥–∫–∞ –¥–∞—ë—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å
    """
    text_lower = ad_text.lower()

    # –ë–∞–∑–æ–≤—ã–π —Å—Ç–∞—Ä—Ç
    score = 0.5

    # –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã: —Å–∫–∏–¥–∫–∞, –Ω–æ–≤–∏–Ω–∫–∞, –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ —Ç.–ø.
    if "—Å–∫–∏–¥" in text_lower:
        score += 0.20
    if "–±–µ—Å–ø–ª–∞—Ç–Ω" in text_lower:
        score += 0.10
    if "–Ω–æ–≤–∏–Ω" in text_lower:
        score += 0.05
    if "–¥–æ—Å—Ç–∞–≤–∫–∞" in text_lower:
        score += 0.05
    if "—Ö–∏—Ç" in text_lower or "–±–µ—Å—Ç—Å–µ–ª–ª–µ—Ä" in text_lower:
        score += 0.05

    # –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ‚Äî —Ö—É–∂–µ
    length = len(ad_text)
    if length < 80:
        score -= 0.10
    elif length > 600:
        score -= 0.10

    # –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å–µ–≥–º–µ–Ω—Ç: –¥–ª—è low_income —Å–∫–∏–¥–∫–∏ –≤–∞–∂–Ω–µ–µ
    if "low_income" in target_audience.lower() and "—Å–∫–∏–¥" in text_lower:
        score += 0.05

    # –ù–æ—Ä–º–∏—Ä—É–µ–º –≤ [0, 1]
    click_probability = max(0.0, min(1.0, score))
    purchase_probability = max(0.0, min(1.0, score - 0.1))

    return {
        "click_probability": click_probability,
        "purchase_probability": purchase_probability,
    }


if __name__ == "__main__":
    # –ü—Ä–∏–º–µ—Ä —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞: –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å `python main.py`
    test_ad = """iPhone 17 ‚Äî —Ç–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π!
–û—â—É—Ç–∏ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å, —É–ª—É—á—à–µ–Ω–Ω—É—é –∫–∞–º–µ—Ä—É –∏ –¥–æ–ª–≥–∏–π —Å—Ä–æ–∫ —Ä–∞–±–æ—Ç—ã –±–∞—Ç–∞—Ä–µ–∏.
üí• –°–∫–∏–¥–∫–∞ 10% —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è! –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É."""

    segment = "Low_income_pragmatic_youth"

    scores = evaluate_ad(test_ad, segment)
    print("–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ:\n")
    print(test_ad)
    print("\n–°–µ–≥–º–µ–Ω—Ç:", segment)
    print("–û—Ü–µ–Ω–∫–∞:", scores)
